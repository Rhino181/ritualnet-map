<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>RITUALNET</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@600&display=swap');
    *, *::before, *::after {margin:0;padding:0;box-sizing:border-box;}
    
    html, body {
      margin: 0; padding: 0; background: #000; overflow: hidden;
      height: 100dvh; width: 100vw; font-family: 'Rajdhani', sans-serif;
      color: #0f0; touch-action: manipulation; position: fixed;
    }

    #map {
      position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; z-index: 1;
    }
    .leaflet-control-zoom, .leaflet-control-attribution {display: none !important;}

    .title-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 110px;
      background: linear-gradient(to bottom, rgba(0,30,0,0.98), transparent);
      display: flex; align-items: center; justify-content: center; gap: 15px;
      z-index: 100; user-select: none; padding-top: env(safe-area-inset-top);
      flex-wrap: wrap; padding: 10px;
    }
    #ritualLogo {
      width: 70px; height: 70px; cursor: pointer;
      filter: drop-shadow(0 0 40px #00ff41); animation: glow 5s infinite alternate;
      transition: 0.3s; position: relative; flex-shrink: 0;
    }
    #ritualLogo img {width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 2;}
    #ritualLogo::before {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      width: 68%; height: 68%; background: url('ritualnet-logo.png') center/contain no-repeat;
      opacity: 0.18; z-index: -1; pointer-events: none; animation: ritualPulse 6s infinite ease-in-out;
    }
    #ritualLogo:hover {transform: scale(1.25);}

    .title-text {
      font-family: 'Orbitron', sans-serif; font-weight: 900;
      background: linear-gradient(90deg, #00ff41, #00ff99);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 60px #00ff4188; letter-spacing: 8px; cursor: pointer;
      position: relative; font-size: clamp(36px, 8vw, 56px);
      white-space: nowrap; text-align: center;
    }
    .title-text::before {
      content: 'RITUALNET'; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      font-size: inherit; letter-spacing: 8px; opacity: 0.18;
      background: linear-gradient(90deg, #00ff41, #00ff99);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      animation: ritualPulse 6s infinite ease-in-out; z-index: -1;
    }

    .subtitle {
      position: fixed; top: calc(110px + env(safe-area-inset-top));
      left: 50%; transform: translateX(-50%);
      font-size: 14px; letter-spacing: 2px; color: #00ff88;
      text-shadow: 0 0 20px #00ff41; font-family: 'Orbitron', sans-serif;
      white-space: nowrap; z-index: 100;
    }

    .counter-box {
      position: fixed; top: 20px; right: 20px; z-index: 100;
      background: rgba(0,0,0,0.95); border: 3px solid #00ff41;
      border-radius: 20px; padding: 15px 25px;
      box-shadow: 0 0 40px rgba(0,255,65,0.6);
      font-family: 'Orbitron', sans-serif;
      text-align: center; min-width: 180px;
      backdrop-filter: blur(10px);
    }
    .counter-box .count {
      font-size: 48px; font-weight: 900;
      background: linear-gradient(90deg, #00ff41, #00ff99);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px #00ff41;
      line-height: 1; margin-bottom: 5px;
      animation: countGlow 3s infinite alternate;
    }
    .counter-box .label {
      font-size: 12px; color: #00ff88;
      text-transform: uppercase; letter-spacing: 2px;
      text-shadow: 0 0 10px #00ff41;
    }
    @keyframes countGlow {
      0% {text-shadow: 0 0 20px #00ff41;}
      100% {text-shadow: 0 0 40px #00ff41;}
    }

    @keyframes glow {0%{filter: drop-shadow(0 0 30px #00ff41);}100%{filter: drop-shadow(0 0 70px #00ff41);}}
    @keyframes ritualPulse {
      0%,100%{opacity:0.15;transform:translate(-50%,-50%) scale(1);}
      50%{opacity:0.25;transform:translate(-50%,-50%) scale(1.08);}
    }

    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
      background: rgba(0,0,0,0.98); backdrop-filter: blur(20px);
      display: none; align-items: center; justify-content: center;
      z-index: 200; padding: 20px; overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
      opacity: 0; transition: opacity 0.2s ease;
    }
    .modal.show {display: flex; opacity: 1;}
    
    .card {
      width: 430px; max-width: 95vw; background: #000; padding: 50px 40px;
      border: 3px solid #00ff41; border-radius: 30px; text-align: center; position: relative;
      box-shadow: 0 0 100px rgba(0,255,65,0.7);
      transform: scale(0.9); transition: transform 0.2s ease;
    }
    .modal.show .card {transform: scale(1);}
    
    .close-btn {
      position: absolute; top: 20px; right: 25px; width: 40px; height: 40px;
      background: transparent; border: 2px solid #00ff41; border-radius: 50%;
      color: #00ff41; font-size: 28px; cursor: pointer; transition: 0.2s;
    }
    .close-btn:hover {background: #00ff4111; transform: rotate(90deg);}
    .card h2 {
      font-family: 'Orbitron', sans-serif; color: #00ff41; font-size: 42px;
      text-shadow: 0 0 30px #00ff41; margin-bottom: 40px; letter-spacing: 8px;
    }

    .avatar-circle {
      width: 140px; height: 140px; border-radius: 50%; margin: 30px auto;
      border: 6px solid #00ff41; overflow: hidden; background: #000;
      box-shadow: 0 0 60px #00ff4188; position: relative;
    }
    .avatar-circle img {width: 100%; height: 100%; object-fit: cover; z-index: 2;}
    .avatar-circle::before {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      width: 68%; height: 68%; background: url('ritualnet-logo.png') center/contain no-repeat;
      opacity: 0.18; z-index: 1; pointer-events: none; animation: ritualPulse 6s infinite ease-in-out;
    }

    .upload-btn, .input-field, .pledge-field {
      width: 100%; padding: 18px; margin: 18px 0; background: #001100;
      border: 2px dashed #00ff41; border-radius: 20px; color: #00ff88;
      font-size: 18px; text-align: center; cursor: pointer; transition: 0.3s;
    }
    .upload-btn:hover, .input-field:focus, .pledge-field:focus {
      background: #002200; border-style: solid; outline: none;
    }
    .pledge-field {height: 100px; resize: none; text-align: left; padding: 20px;}
    .join-btn {
      margin-top: 30px; padding: 20px 80px; background: #00ff41; color: #000;
      border: none; border-radius: 50px; font-family: 'Orbitron', sans-serif;
      font-size: 28px; font-weight: 900; cursor: pointer;
      box-shadow: 0 0 60px #00ff41; transition: 0.2s;
      position: relative; overflow: hidden;
    }
    .join-btn:hover {transform: scale(1.05); box-shadow: 0 0 100px #00ff41;}
    .join-btn:active {transform: scale(0.98);}

    .success {
      position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: rgba(0,0,0,0.95);
      display: none; align-items: center; justify-content: center; flex-direction: column;
      z-index: 300; color: #00ff41; text-align: center; opacity: 0;
      transition: opacity 0.3s ease; padding: 20px;
      backdrop-filter: blur(10px);
    }
    .success.active {display: flex; opacity: 1;}

    .success h1 {
      font-family: 'Orbitron', sans-serif; font-size: clamp(48px, 12vw, 72px);
      text-shadow: 0 0 80px #00ff41, 0 0 40px #00ff41; 
      margin: 0; position: relative; z-index: 2;
      animation: fadeInUp 0.6s ease-out forwards;
      letter-spacing: 4px;
    }
    .success p {
      margin-top: 30px; font-size: clamp(18px, 4vw, 24px); opacity: 0;
      animation: fadeIn 0.4s ease 0.3s forwards; z-index: 2;
      text-shadow: 0 0 20px #00ff41;
    }
    .ritual-circle {
      position: absolute; width: 200px; height: 200px; border: 4px solid #00ff41;
      border-radius: 50%; box-shadow: 0 0 100px #00ff41, inset 0 0 80px #00ff41;
      animation: expandGlow 1.2s ease-out forwards; opacity: 0; z-index: 1;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
    }
    @keyframes expandGlow {
      0% {width: 0; height: 0; opacity: 1; border-width: 6px;}
      50% {width: 400px; height: 400px; opacity: 0.8; border-width: 4px;}
      100% {width: 600px; height: 600px; opacity: 0; border-width: 2px;}
    }
    @keyframes fadeInUp {
      0% {opacity: 0; transform: translateY(50px) scale(0.9);}
      100% {opacity: 1; transform: translateY(0) scale(1);}
    }
    @keyframes fadeIn {
      0% {opacity: 0; transform: translateY(20px);}
      100% {opacity: 0.9; transform: translateY(0);}
    }

    .panel {
      position: fixed; left: 15px; bottom: 15px;
      width: 300px; max-width: calc(100vw - 30px); max-height: 240px;
      background: #000; border: 3px solid #00ff41; border-radius: 20px; padding: 12px;
      box-shadow: 0 0 60px rgba(0,255,65,0.6); z-index: 10; overflow-y: auto;
      display: flex; flex-direction: column; scroll-behavior: smooth; overscroll-behavior: contain;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .panel h3 {
      font-family: 'Orbitron', sans-serif; color: #00ff41; font-size: 18px;
      text-shadow: 0 0 20px #00ff41; margin-bottom: 8px; text-align: center;
      background: #001100; padding: 8px; border-radius: 15px;
      box-shadow: 0 0 30px #00ff41 inset; font-weight: 900; flex-shrink: 0;
    }
    .entry {
      display: flex; align-items: center; margin: 8px 0; padding: 10px;
      background: rgba(0,255,65,0.08); border: 2px solid #00ff41;
      border-radius: 15px; position: relative; flex-shrink: 0; scroll-snap-align: start;
      animation: slideIn 0.2s ease-out;
    }
    @keyframes slideIn {
      from {opacity: 0; transform: translateY(-10px);}
      to {opacity: 1; transform: translateY(0);}
    }
    .entry img {
      width: 36px; height: 36px; border-radius: 50%; border: 2px solid #00ff41;
      margin-right: 10px; box-shadow: 0 0 20px #00ff4188; z-index: 2;
    }
    .entry::before {
      content: ''; position: absolute; top: 50%; left: 18px; transform: translate(-50%,-50%);
      width: 28px; height: 28px; background: url('ritualnet-logo.png') center/contain no-repeat;
      opacity: 0.18; z-index: 1; pointer-events: none; animation: ritualPulse 5s infinite ease-in-out;
    }
    .entry .name {
      color: #00ff88; font-weight: bold; font-family: 'Orbitron', sans-serif;
      font-size: 14px; text-align: left; flex: 1;
    }
    .entry .pledge {
      color: #00ff88; font-size: 12px; margin-top: 2px; text-align: left; flex: 1;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .ritual-marker {
      animation: markerAppear 0.2s ease-out;
    }
    .ritual-marker img {
      border-radius: 50%; border: 4px solid #00ff41; box-shadow: 0 0 30px #00ff41; z-index: 2;
    }
    .ritual-marker::after {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      width: 60%; height: 60%; background: url('ritualnet-logo.png') center/contain no-repeat;
      opacity: 0.18; z-index: 1; pointer-events: none; animation: ritualPulse 7s infinite ease-in-out;
    }
    @keyframes markerAppear {
      0% {transform: scale(0); opacity: 0;}
      70% {transform: scale(1.15);}
      100% {transform: scale(1); opacity: 1;}
    }

    #resetConfirm {
      position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: rgba(0,0,0,0.98);
      backdrop-filter: blur(20px); display: none; align-items: center; justify-content: center;
      flex-direction: column; z-index: 400; color: #00ff41; text-align: center; font-family: 'Orbitron', sans-serif;
    }
    #resetConfirm button {
      margin: 15px; font-size: 22px; padding: 14px 50px; border-radius: 40px;
      font-family: 'Orbitron', sans-serif; font-weight: 900; cursor: pointer; transition: 0.2s;
    }
    #confirmReset {background: #00ff41; color: #000; box-shadow: 0 0 60px #00ff41;}
    #confirmReset:hover {transform: scale(1.05);}
    #cancelReset {background: #333; color: #00ff41; border: 2px solid #00ff41;}
    #cancelReset:hover {background: #444;}

    .leaflet-popup-content-wrapper {
      background: #000 !important; color: #0f0 !important;
      border: 3px solid #00ff41 !important; border-radius: 20px !important;
      padding: 0 !important; box-shadow: 0 0 40px rgba(0,255,65,0.6) !important;
    }
    .leaflet-popup-content {
      margin: 0 !important; padding: 12px !important; text-align: center !important;
      font-family: 'Orbitron', sans-serif !important; position: relative;
    }
    .leaflet-popup-content img {
      width: 70px !important; height: 70px !important; border-radius: 50% !important;
      border: 3px solid #00ff41 !important; margin-bottom: 10px !important;
      box-shadow: 0 0 20px #00ff41 !important; z-index: 2;
    }
    .leaflet-popup-content::before {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 40px; height: 40px; background: url('ritualnet-logo.png') center/contain no-repeat;
      opacity: 0.18; z-index: 1; pointer-events: none; animation: ritualPulse 6s infinite ease-in-out;
    }
    .leaflet-popup-content b {color: #00ff41 !important; font-size: 16px !important; display: block; margin: 6px 0;}
    .leaflet-popup-content i {font-size: 13px !important; opacity: 0.9; display: block;}
    .leaflet-popup-tip {background: #00ff41 !important; box-shadow: 0 0 20px #00ff41 !important;}
    
    .delete-marker-btn {
      margin-top: 10px; padding: 8px 20px; background: #ff0000; color: #fff;
      border: 2px solid #ff0000; border-radius: 20px; cursor: pointer;
      font-family: 'Orbitron', sans-serif; font-size: 12px; font-weight: 700;
      box-shadow: 0 0 20px rgba(255,0,0,0.5); transition: 0.2s;
      display: none;
    }
    .admin-mode .delete-marker-btn {display: inline-block;}
    .delete-marker-btn:hover {
      background: #cc0000; transform: scale(1.05); box-shadow: 0 0 30px rgba(255,0,0,0.8);
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="title-bar">
    <div id="ritualLogo"><img src="ritualnet-logo.png" draggable="false"></div>
    <div class="title-text" id="titleLink">RITUALNET</div>
  </div>

  <div class="subtitle">Let's Make The World Ritualize</div>

  <div class="counter-box">
    <div class="count" id="ritualCount">0</div>
    <div class="label">RITUALIZED</div>
  </div>

  <div class="panel">
    <h3>Recent Summonings</h3>
    <div id="recent"></div>
  </div>

  <div class="modal" id="ritualModal">
    <div class="card">
      <div class="close-btn" id="closeBtn">X</div>
      <h2>PERFORM THE RITUAL</h2>
      <div class="avatar-circle"><img src="ritualnet-logo.png" id="avatarPreview" draggable="false"></div>
      <label class="upload-btn">UPLOAD AVATAR</label>
      <input type="file" id="avatarInput" accept="image/*" style="display:none;">
      <input type="text" class="input-field" id="username" placeholder="X / Twitter username">
      <textarea class="pledge-field input-field" id="pledge" placeholder="Write your pledge..."></textarea>
      <button class="join-btn">JOIN THE CIRCLE</button>
    </div>
  </div>

  <div class="success" id="success">
    <div class="ritual-circle"></div>
    <h1>YOU ARE RITUALIZED</h1>
    <p>The circle grows stronger.</p>
  </div>

  <div id="resetConfirm">
    <div style="font-size:24px; margin-bottom:20px;">RESET THE CIRCLE?</div>
    <button id="confirmReset">BURN IT ALL</button>
    <button id="cancelReset">CANCEL</button>
  </div>

  <script>
    const SUPABASE_URL = 'https://xgttfiqewnwpqguhbpgv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndHRmaXFld253cHFndWhicGd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxOTY1ODgsImV4cCI6MjA3ODc3MjU4OH0.zVK46pTGH0_Ruu20s35ep8NnsQd2ROenG_EuWezXiWg';
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    window.addEventListener('load', () => {
      const bounds = L.latLngBounds([[-89, -200], [89, 200]]);

      const map = L.map('map', { 
        zoomControl: false, 
        attributionControl: false,
        minZoom: 2,
        maxZoom: 19,
        maxBounds: bounds,
        maxBoundsViscosity: 0.5,
        worldCopyJump: false,
        inertia: true,
        inertiaDeceleration: 3000,
        inertiaMaxSpeed: 1500,
        zoomAnimation: true,
        zoomAnimationThreshold: 4,
        markerZoomAnimation: true,
        fadeAnimation: true,
        preferCanvas: true
      }).setView([10, 0], 2);

      L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', { 
        maxZoom: 19 
      }).addTo(map);

      setTimeout(() => map.invalidateSize(), 50);

      const markers = L.layerGroup().addTo(map);
      const recent = document.getElementById('recent');
      const countDisplay = document.getElementById('ritualCount');
      let clickedPos = null;
      let logoClicks = 0;
      let adminMode = false;
      let adminClickTimer = null;
      let totalCount = 0;

      function updateCounter(count) {
        totalCount = count;
        countDisplay.textContent = count;
      }

      console.log('ðŸš€ RITUALNET - Optimized IO v2.0');

      function getSize() {
        const z = map.getZoom();
        if (z <= 3) return 30;
        if (z <= 5) return 40;
        if (z <= 7) return 50;
        return 65;
      }

      function createIcon(src) {
        const s = getSize();
        return L.divIcon({
          className: 'ritual-marker',
          html: `<img src="${src}" style="width:${s}px;height:${s}px;">`,
          iconSize: [s, s],
          iconAnchor: [s/2, s/2]
        });
      }

      map.on('zoomend', () => {
        markers.eachLayer(m => {
          if (m.options.data?.avatar) m.setIcon(createIcon(m.options.data.avatar));
        });
      });

      function addMarkerToMap(s) {
        const icon = createIcon(s.avatar || 'ritualnet-logo.png');
        const m = L.marker([s.lat, s.lng], { icon, data: s }).addTo(markers);
        updateMarkerPopup(m);
        return m;
      }

      function updateMarkerPopup(marker) {
        const s = marker.options.data;
        if (!s) return;
        
        const deleteBtn = adminMode ? 
          `<button class="delete-marker-btn" onclick="window.deleteMarker('${s.id}')">DELETE</button>` : '';
        
        marker.bindPopup(`
          <div>
            <img src="${s.avatar || 'ritualnet-logo.png'}">
            <b>@${s.name}</b>
            <i>"${s.pledge}"</i>
            ${deleteBtn}
          </div>
        `);
      }

      window.deleteMarker = async function(markerId) {
        if (!adminMode) return;
        
        if (!confirm('Delete this summoning permanently?')) return;
        
        try {
          const { error } = await supabase
            .from('summonings')
            .delete()
            .eq('id', markerId);
          
          if (error) throw error;
          
          // Remove from map
          markers.eachLayer(m => {
            if (m.options.data?.id === markerId) {
              markers.removeLayer(m);
            }
          });
          
          // Remove from recent list
          const entry = document.querySelector(`.entry[data-id="${markerId}"]`);
          if (entry) entry.remove();
          
          updateCounter(Math.max(0, totalCount - 1));
          
          // CRITICAL: Update cache to remove deleted item
          try {
            const cached = localStorage.getItem('ritualnet_cache');
            if (cached) {
              const cachedData = JSON.parse(cached);
              if (cachedData.data) {
                cachedData.data = cachedData.data.filter(s => s.id !== markerId);
                localStorage.setItem('ritualnet_cache', JSON.stringify(cachedData));
                console.log('ðŸ’¾ Cache updated after delete');
              }
            }
          } catch (e) {
            console.warn('Cache update failed:', e);
          }
          
          console.log('âœ… Deleted permanently:', markerId);
        } catch (e) {
          alert('Failed to delete: ' + e.message);
          console.error('Delete error:', e);
        }
      };

      function addToRecent(s, prepend = true) {
        if (s.id && document.querySelector(`.entry[data-id="${s.id}"]`)) return;
        
        const entry = document.createElement('div');
        entry.className = 'entry';
        if (s.id) entry.dataset.id = s.id;
        entry.innerHTML = `
          <img src="${s.avatar || 'ritualnet-logo.png'}">
          <div><div class="name">@${s.name}</div><div class="pledge">"${s.pledge}"</div></div>
        `;
        
        if (prepend) {
          recent.insertBefore(entry, recent.firstChild);
        } else {
          recent.appendChild(entry);
        }
      }

      async function loadAll() {
        const CACHE_MAX_AGE = 7 * 24 * 60 * 60 * 1000;
        const CACHE_FRESH_AGE = 60 * 60 * 1000;
        
        try {
          const cached = localStorage.getItem('ritualnet_cache');
          if (cached) {
            const cachedData = JSON.parse(cached);
            const cacheAge = Date.now() - (cachedData.timestamp || 0);
            
            if (cacheAge < CACHE_MAX_AGE && cachedData.data && Array.isArray(cachedData.data)) {
              console.log('ðŸ“¦ Cache:', cachedData.data.length, 'markers, age:', Math.round(cacheAge/60000), 'min');
              cachedData.data.forEach(s => {
                addMarkerToMap(s);
                addToRecent(s, false);
              });
              updateCounter(cachedData.data.length);
              
              if (cacheAge < CACHE_FRESH_AGE) {
                console.log('âœ… Fresh cache (<1hr) - Skipped DB query - 100% IO saved!');
                return;
              }
            }
          }
        } catch (e) {
          console.warn('Cache load failed:', e);
        }

        try {
          console.log('ðŸ”„ Fetching fresh data (limit: 25, was 100)...');
          const { data, error } = await supabase
            .from('summonings')
            .select('*')
            .order('timestamp', { ascending: false })
            .limit(25);
          
          if (error) throw error;
          
          if (data && data.length > 0) {
            console.log('âœ… Loaded:', data.length, 'markers (75% less data)');
            
            updateCounter(data.length);
            
            try {
              localStorage.setItem('ritualnet_cache', JSON.stringify({ 
                data: data,
                timestamp: Date.now() 
              }));
              console.log('ðŸ’¾ Cache updated');
            } catch (e) {
              console.warn('Cache save failed:', e);
            }
            
            const existingIds = new Set();
            markers.eachLayer(m => {
              if (m.options.data?.id) existingIds.add(m.options.data.id);
            });
            
            const hasChanges = data.some(s => !existingIds.has(s.id)) || 
                               data.length !== existingIds.size;
            
            if (hasChanges) {
              console.log('ðŸ”„ Data changed, refreshing UI');
              markers.clearLayers();
              recent.innerHTML = '';
              data.forEach(s => {
                addMarkerToMap(s);
                addToRecent(s, false);
              });
            }
          }
        } catch (e) {
          console.warn('Load error:', e);
        }
      }

      loadAll();

      console.log('ðŸ”— Setting up realtime subscriptions...');

      // Create a unique channel for this session
      const channelName = 'summonings-changes-' + Math.random().toString(36).substr(2, 9);
      
      const channel = supabase
        .channel(channelName, {
          config: {
            broadcast: { self: false },
            presence: { key: '' }
          }
        })
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'summonings'
          },
          (payload) => {
            console.log('âš¡ INSERT event received:', payload);
            const row = payload.new;
            
            // Check if this marker already exists
            let alreadyExists = false;
            markers.eachLayer(m => {
              if (m.options.data?.id === row.id) {
                alreadyExists = true;
              }
            });
            
            if (!alreadyExists) {
              console.log('âœ… Adding new marker from realtime:', row.id);
              addMarkerToMap(row);
              addToRecent(row, true);
              updateCounter(totalCount + 1);
              
              // Update cache with new entry
              try {
                const cached = localStorage.getItem('ritualnet_cache');
                if (cached) {
                  const cachedData = JSON.parse(cached);
                  if (cachedData.data) {
                    cachedData.data.unshift(row);
                    if (cachedData.data.length > 25) cachedData.data.pop();
                    cachedData.timestamp = Date.now(); // Refresh cache timestamp
                    localStorage.setItem('ritualnet_cache', JSON.stringify(cachedData));
                  }
                }
              } catch (e) {
                console.warn('Cache update failed:', e);
              }
            } else {
              console.log('â„¹ï¸ Marker already exists, skipping:', row.id);
            }
          }
        )
        .on(
          'postgres_changes',
          {
            event: 'DELETE',
            schema: 'public',
            table: 'summonings'
          },
          (payload) => {
            console.log('âš¡ DELETE event received:', payload);
            const deletedId = payload.old.id;
            
            // Remove from map
            markers.eachLayer(m => {
              if (m.options.data?.id === deletedId) {
                markers.removeLayer(m);
                console.log('âœ… Removed marker from map:', deletedId);
              }
            });
            
            // Remove from recent list
            const entry = document.querySelector(`.entry[data-id="${deletedId}"]`);
            if (entry) {
              entry.remove();
              console.log('âœ… Removed from recent list:', deletedId);
            }
            
            updateCounter(Math.max(0, totalCount - 1));
            
            // Update cache
            try {
              const cached = localStorage.getItem('ritualnet_cache');
              if (cached) {
                const cachedData = JSON.parse(cached);
                if (cachedData.data) {
                  cachedData.data = cachedData.data.filter(s => s.id !== deletedId);
                  localStorage.setItem('ritualnet_cache', JSON.stringify(cachedData));
                }
              }
            } catch (e) {
              console.warn('Cache update failed:', e);
            }
          }
        )
        .subscribe((status, err) => {
          console.log('ðŸ“¡ Realtime subscription status:', status);
          if (err) {
            console.error('âŒ Realtime subscription error:', err);
          }
          if (status === 'SUBSCRIBED') {
            console.log('âœ… Successfully subscribed to realtime updates!');
          }
          if (status === 'CHANNEL_ERROR') {
            console.error('âŒ Channel error - realtime not working');
          }
          if (status === 'TIMED_OUT') {
            console.error('âŒ Subscription timed out');
          }
        });

      map.on('click', e => {
        clickedPos = e.latlng;
        const modal = document.getElementById('ritualModal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
        
        // Reset form
        document.getElementById('avatarPreview').src = 'ritualnet-logo.png';
        document.getElementById('username').value = '';
        document.getElementById('pledge').value = '';
        
        // Focus on username field for better UX
        setTimeout(() => {
          document.getElementById('username').focus();
        }, 300);
      });

      document.getElementById('titleLink').onclick = () => window.open('https://x.com/ritualnet', '_blank');

      const closeModal = () => {
        const modal = document.getElementById('ritualModal');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 200);
      };

      document.getElementById('closeBtn').onclick = closeModal;
      document.querySelector('.modal').onclick = e => {
        if (e.target.classList.contains('modal')) closeModal();
      };

      document.querySelector('.upload-btn').onclick = () => document.getElementById('avatarInput').click();
      document.getElementById('avatarInput').onchange = e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => document.getElementById('avatarPreview').src = ev.target.result;
          reader.readAsDataURL(file);
        }
      };

      document.querySelector('.join-btn').onclick = () => {
        const avatar = document.getElementById('avatarPreview').src;
        const name = document.getElementById('username').value.trim() || "ritualist";
        const pledge = document.getElementById('pledge').value.trim() || "I have joined.";
        if (!clickedPos) return;

        const tempId = 'temp-' + Date.now();
        const newSummon = { 
          id: tempId,
          name, 
          pledge, 
          avatar, 
          lat: clickedPos.lat, 
          lng: clickedPos.lng, 
          timestamp: Date.now() 
        };

        // Close modal first for smooth transition
        closeModal();
        
        // Small delay for modal close animation
        setTimeout(() => {
          // Show success animation
          const success = document.getElementById('success');
          success.classList.add('active');
          
          // Smooth zoom to marker location
          const currentZoom = map.getZoom();
          const targetZoom = currentZoom < 8 ? 8 : currentZoom;
          
          map.flyTo(clickedPos, targetZoom, { 
            duration: 1.2,
            easeLinearity: 0.25
          });
          
          // Add marker after zoom starts (feels more natural)
          setTimeout(() => {
            const marker = addMarkerToMap(newSummon);
            addToRecent(newSummon, true);
            updateCounter(totalCount + 1);
            
            // Save to database in background
            supabase.from('summonings')
              .insert({
                name, 
                pledge, 
                avatar, 
                lat: clickedPos.lat, 
                lng: clickedPos.lng, 
                timestamp: newSummon.timestamp
              })
              .select()
              .then(({ data, error }) => {
                if (error) {
                  console.warn('Save error:', error);
                } else if (data && data[0]) {
                  marker.options.data.id = data[0].id;
                  const tempEntry = document.querySelector(`.entry[data-id="${tempId}"]`);
                  if (tempEntry) {
                    tempEntry.dataset.id = data[0].id;
                  }
                  console.log('âœ… Saved to database:', data[0].id);
                }
              })
              .catch(err => {
                console.error('Database save failed:', err);
              });
          }, 300);
          
          // Hide success animation after 2.5 seconds
          setTimeout(() => {
            success.classList.remove('active');
          }, 2500);
          
        }, 200);
      };

      document.getElementById('ritualLogo').onclick = () => {
        logoClicks++;
        if (adminClickTimer) clearTimeout(adminClickTimer);
        
        if (logoClicks === 7) {
          adminMode = !adminMode;
          document.body.classList.toggle('admin-mode', adminMode);
          
          const logo = document.getElementById('ritualLogo');
          if (adminMode) {
            logo.style.filter = 'drop-shadow(0 0 40px #ff0000)';
            alert('ðŸ”´ ADMIN MODE ACTIVATED\n\nClick any marker to see DELETE option.');
          } else {
            logo.style.filter = '';
            alert('âœ… Admin mode deactivated');
          }
          
          markers.eachLayer(m => {
            if (m.options.data) {
              updateMarkerPopup(m);
            }
          });
          
          logoClicks = 0;
        } else if (logoClicks === 14) {
          document.getElementById('resetConfirm').style.display = 'flex';
          logoClicks = 0;
        } else {
          adminClickTimer = setTimeout(() => { logoClicks = 0; }, 3000);
        }
      };

      document.getElementById('confirmReset').onclick = async () => {
        await supabase.from('summonings').delete().neq('timestamp', 0);
        markers.clearLayers();
        recent.innerHTML = '';
        updateCounter(0);
        localStorage.removeItem('ritualnet_cache');
        document.getElementById('resetConfirm').style.display = 'none';
        console.log('ðŸ”¥ Database reset complete');
      };

      document.getElementById('cancelReset').onclick = () => {
        document.getElementById('resetConfirm').style.display = 'none';
      };
    });
  </script>
</body>
</html>
